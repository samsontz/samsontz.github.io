<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ARÂ NavigationÂ â€“Â Waypoint Edition (v5.3Â â€¢ rearâ€‘cameraâ€‘only)</title>

  <!-- Three.js (nonâ€‘module build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    /* ---Â UI & layout --- */
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #000; color: #fff; overflow: hidden;}
    #video, #canvas {position: absolute; inset: 0; width: 100vw; height: 100vh;}
    #canvas {pointer-events: none; z-index: 2;}
    #video  {object-fit: cover; z-index: 1;}
    .ui-overlay {position: absolute; z-index: 3; font-weight: 500;}
    .top-bar {top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,.7); padding: 15px 20px; border-radius: 24px; backdrop-filter: blur(8px);}
    .distance-time {font-size: 18px; font-weight: 600;}
    .eta {opacity: .8; font-size: 14px;}
    .compass {width: 50px; height: 50px; border: 2px solid rgba(255,255,255,.35); border-radius: 50%; display: flex; align-items: center; justify-content: center;}
    .compass-needle {width: 3px; height: 20px; background: #4285f4; border-radius: 2px; transform-origin: bottom center; transition: transform .3s;}
    .bottom-controls {bottom: 24px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center;}
    .control-btn {background: rgba(0,0,0,.8); backdrop-filter: blur(8px); border: none; color: #fff; width: 54px; height: 54px; font-size: 24px; border-radius: 50%; cursor: pointer; transition: .25s; display: flex; align-items: center; justify-content: center;}
    .control-btn:hover {background: rgba(255,255,255,.25); transform: scale(1.1);}
    .center-crosshair {position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 32px; height: 32px; border: 2px solid rgba(255,255,255,.6); border-radius: 50%; pointer-events: none; z-index: 4;}
    .center-crosshair::before {content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 6px; height: 6px; background: rgba(255,255,255,.85); border-radius: 50%;}
    .status-indicator {position: absolute; top: 92px; right: 20px; background: rgba(0,0,0,.8); padding: 10px 16px; border-radius: 20px; font-size: 12px; backdrop-filter: blur(8px);}
    .gps-accuracy {color: #4caf50;}
    .gps-searching {color: #ff9800;}
    /* permission overlay */
    #permOverlay {position: fixed; inset: 0; background: rgba(0,0,0,.92); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; z-index: 1000;}
    #permOverlay.hidden {display: none;}
    #permOverlay button {padding: 14px 28px; font-size: 17px; border: none; border-radius: 6px; background: #4285f4; color: #fff; cursor: pointer;}
    #permOverlay button:hover {background: #2a6ad3;}
    @keyframes pulse {0%,100% {transform: scale(1); opacity:1} 50% {transform: scale(1.25); opacity:.65}}
  </style>
</head>
<body>

  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- overlays -->
  <div class="center-crosshair"></div>
  <div class="ui-overlay top-bar">
    <div><div id="distanceTime" class="distance-time">â€”</div><div id="eta" class="eta">StandÂ byâ€¦</div></div>
    <div class="compass"><div id="compassNeedle" class="compass-needle"></div></div>
  </div>
  <div class="ui-overlay bottom-controls">
    <button id="recenterBtn" class="control-btn" title="Reâ€‘center">ðŸ”„</button>
    <button id="calibrateBtn" class="control-btn" title="Calibrate">ðŸ§­</button>
  </div>
  <div id="statusIndicator" class="ui-overlay status-indicator"><span class="gps-searching">ðŸ“¡Â SearchingÂ GPSâ€¦</span></div>

  <!-- permission prompt -->
  <div id="permOverlay">
    <h2 style="max-width:320px;text-align:center">This AR demo needs your camera, location and motion sensors.</h2>
    <p id="permMessage" style="max-width:320px;text-align:center"></p>
    <button id="permBtn">Grant permissions</button>
  </div>

  <script>
  /* === helper math === */
  const R=6371e3, DEG=Math.PI/180;
  const dist=(a,b)=>{const Ï†1=a.lat*DEG,Ï†2=b.lat*DEG,dÏ†=(b.lat-a.lat)*DEG,dÎ»=(b.lng-a.lng)*DEG;const h=Math.sin(dÏ†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2;return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));};
  const toXY=(o,p)=>{const m=(o.lat+p.lat)/2*DEG;return{x:R*(p.lng-o.lng)*DEG*Math.cos(m),z:R*(p.lat-o.lat)*DEG};};

  const API='https://waypoints-prht.onrender.com/get-waypoints/';

  /* === global state === */
  let renderer,scene,camera,arrowGroup;
  let cur=null, base=null, fetched=[], wps=[], scale=0.08; let gotGeo=false,gotWps=false;

  /* ===== permissions ===== */
  const overlay=document.getElementById('permOverlay');
  const msg=document.getElementById('permMessage');
  document.getElementById('permBtn').onclick=async()=>{
    try{
      msg.textContent='Requesting rear cameraâ€¦';
      await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}}});
      msg.textContent='Requesting locationâ€¦';
      await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));
      if(DeviceOrientationEvent?.requestPermission){msg.textContent='Requesting motion sensorsâ€¦';await DeviceOrientationEvent.requestPermission();}
      overlay.classList.add('hidden');
      startApp();
    }catch(e){msg.textContent='Permission denied (need rearâ€‘camera).';console.error(e);} };

  /* ===== camera ===== */
  async function initCamera(){
    const v=document.getElementById('video');
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}}});
    v.srcObject=s; await new Promise(r=>v.onloadedmetadata=r); await v.play();
  }

  /* ===== three.js ===== */
  function initThree(){
    renderer=new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),alpha:true,antialias:true});
    renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(devicePixelRatio);
    scene=new THREE.Scene();
    camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.01,1000);
    camera.position.set(0,1.6,0);
    scene.add(new THREE.AmbientLight(0xffffff,0.8));
    const dl=new THREE.DirectionalLight(0xffffff,0.7);dl.position.set(15,25,8);scene.add(dl);
    arrowGroup=new THREE.Group();scene.add(arrowGroup);
  }

  /* ===== orientation ===== */
  function initOrientation(){
    const h=e=>{const a=e.alpha||0,b=e.beta||0;document.getElementById('compassNeedle').style.transform=`rotate(${360-a}deg)`;camera.rotation.set(b*DEG,a*DEG,0,'YXZ');};
    if(DeviceOrientationEvent?.requestPermission){DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')addEventListener('deviceorientation',h);});}else addEventListener('deviceorientation',h);
  }

  /* ===== geolocation ===== */
  function initGeo(){navigator.geolocation.watchPosition(p=>{cur={lat:p.coords.latitude,lng:p.coords.longitude};if(!base){base={...cur};gotGeo=true;buildWhenReady();}updateHUD();shift();},err=>console.error(err),{enableHighAccuracy:true,timeout:10000,maximumAge:3000});}

  /* ===== waypoints ===== */
  async function fetchWps(){
      const id=new URLSearchParams(location.search).get('routeId');
      if(!id){throw new Error('Missing ?routeId parameter');}
      const res=await fetch(API+id).catch(()=>null);
      if(!res||!res.ok) throw new Error('Unable to reach waypoint server');
      const data=await res.json().catch(()=>({}));
      if(!Array.isArray(data.waypoints)||data.waypoints.length===0){
        throw new Error('No waypoints found for routeId "'+id+'"');
      }
      return data.waypoints;
  }(d.waypoints)?d.waypoints:[];}
  function prepWps(){const rel=p=>({...p,rel:toXY(base,p)});wps=[{...base,rel:{x:0,z:0}}].concat(fetched.map(rel));}

  /* ===== meshes ===== */
  const mkArrow=(()=>{const shaftG=new THREE.CylinderGeometry(0.06,0.06,0.9,8),headG=new THREE.ConeGeometry(0.14,0.28,12);
    return()=>{const g=new THREE.Group();const shaft=new THREE.Mesh(shaftG,new THREE.MeshLambertMaterial({color:0x00ff40}));shaft.rotation.x=Math.PI/2;shaft.position.z=0.45;g.add(shaft);const head=new THREE.Mesh(headG,new THREE.MeshLambertMaterial({color:0xff2020}));head.rotation.x=Math.PI/2;head.position.z=0.9;g.add(head);g.userData.p=Math.random()*Math.PI*2;return g;};})();
  function mkPin(){const g=new THREE.Group(),red=new THREE.MeshLambertMaterial({color:0xc41230,emissive:0xc41230});g.add(new THREE.Mesh(new THREE.CylinderGeometry(0.45,0.35,0.6,6),red));const core=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.1,6),new THREE.MeshLambertMaterial({color:0xffffff}));core.position.y=0.33;g.add(core);const tip=new THREE.Mesh(new THREE.ConeGeometry(0.12,0.45,14),red);tip.position.y=-0.45;g.add(tip);return g;}

  /* ===== build scene ===== */
  function buildScene(){arrowGroup.clear();if(wps.length<2)return;const far=Math.max(...wps.map(p=>Math.hypot(p.rel.x,p.rel.z)));scale=25/Math.max(far,25);
    const dst=wps[wps.length-1].rel;const pin=mkPin();pin.scale.setScalar(2*scale);pin.position.set(dst.x*scale,0,dst.z*scale);arrowGroup.add(pin);
    for(let i=0;i<wps.length-1;i++){const a=wps[i].rel,b=wps[i+1].rel,dx=b.x-a.x,dz=b.z-a.z,l=Math.hypot(dx,dz),yaw=Math.atan2(dx,dz);const n=Math.max(3,Math.floor(l/8));for(let j=0;j<n;j++){const t=(j+0.5)/n,m=mkArrow();m.rotation.y=-yaw;m.scale.setScalar(4*scale);m.position.set((a.x+dx*t)*scale,0.03,(a.z+dz*t)*scale);arrowGroup.add(m);}}shift();}

  /* ===== scene shift ===== */
  function shift(){if(!cur||!base)return;const d=toXY(base,cur);arrowGroup.position.set(-d.x*scale,0,-d.z*scale);}

  /* ===== HUD ===== */
  function updateHUD(){if(!cur||!wps.length)return;const m=dist(cur,wps[wps.length-1]),km=m/1000;document.getElementById('distanceTime').textContent=`${km<1?Math.round(m)+' m':km.toFixed(1)+' km'} â€¢ ${Math.round(km*2)} min`;const eta=new Date();eta.setMinutes(eta.getMinutes()+Math.round(km*2));document.getElementById('eta').textContent=`ETA ${eta.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;}

  /* ===== render loop ===== */
  function loop(){requestAnimationFrame(loop);arrowGroup.children.forEach(o=>{if(o.userData?.p!==undefined){o.userData.p+=0.04;o.scale.y=(1+0.25*Math.sin(o.userData.p))*4*scale;}});renderer.render(scene,camera);}

  /* ===== orchestration ===== */
  function buildWhenReady(){if(gotGeo&&gotWps){prepWps();buildScene();loop();}}
  async function startApp(){try{await initCamera();initThree();initOrientation();initGeo();
    try{
      fetched=await fetchWps();
      gotWps=true;
      buildWhenReady();
    }catch(err){
      overlay.classList.remove('hidden');
      msg.textContent=err.message;
      console.error(err);
      return;
    }
    addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});document.getElementById('recenterBtn').onclick=()=>camera.position.set(0,1.6,0);
  }catch(e){overlay.classList.remove('hidden');msg.textContent='Error: '+e.message;console.error(e);}}

  /* HTTPS notice */
  msg.textContent=location.protocol==='https:'?'Tap "Grant permissions" then allow requests.':'This page must be served over HTTPS.';
  if(location.protocol!=='https:')document.getElementById('permBtn').style.display='none';
  </script>
</body>
</html>
