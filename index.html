<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ARÂ NavigationÂ â€“Â Waypoint EditionÂ (v7Â â€¢ logicâ€‘fix)</title>

  <!-- Three.js (quick nonâ€‘module build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    /* ------------ UI & layout ------------ */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;overflow:hidden}
    #video,#canvas{position:absolute;inset:0;width:100vw;height:100vh}
    #canvas{pointer-events:none;z-index:2}
    #video{object-fit:cover;z-index:1}

    .ui-overlay{position:absolute;z-index:3;font-weight:500}
    .top-bar{top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-radius:22px;backdrop-filter:blur(8px);background:rgba(0,0,0,.45)}
    .distance-time{font-size:18px;font-weight:600}.eta{font-size:14px;opacity:.8}
    .compass{width:50px;height:50px;border:2px solid rgba(255,255,255,.6);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .compass-needle{width:3px;height:20px;background:#4285f4;border-radius:2px;transform-origin:bottom center;transition:transform .3s}
    .bottom-controls{bottom:22px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center}
    .control-btn{width:55px;height:55px;border-radius:50%;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;font-size:25px;transition:.25s}
    .control-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}
    .center-crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:18px;height:18px;border:2px solid rgba(255,255,255,.6);border-radius:50%;z-index:4;pointer-events:none}
  </style>
</head>
<body>
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>

  <!-- ---------------- UI overlays ---------------- -->
  <div class="ui-overlay top-bar">
    <div class="distance-time"><span id="distanceTime" class="distance-time">â€”</span><br><span id="eta" class="eta">â€”</span></div>
    <div class="compass"><div id="compassNeedle" class="compass-needle"></div></div>
  </div>
  <div class="ui-overlay bottom-controls">
    <div id="recenterBtn" class="control-btn">â¦¿</div>
    <div id="themeBtn"    class="control-btn">â˜¾</div>
  </div>
  <div class="center-crosshair"></div>

  <div id="overlay" class="ui-overlay" style="top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;backdrop-filter:blur(6px);background:rgba(0,0,0,.55);padding:25px 40px;border-radius:18px">
    <p id="pMsg">ðŸ“¡Â SearchingÂ GPSâ€¦</p>
  </div>

<script>
let renderer, scene, camera, gArrows;
let current=null, base=null;              // gps points
let fetched=[],   wps=[];                 // server + merged wayâ€‘points
let scale=0.1;                            // metres â†’ scene units
let geoOK=false, wapOK=false;
let geoWatchId=null;                      // id for clearWatch if needed

const API = 'https://waypoint-server.example/route/';

const toRad   = d=>d*Math.PI/180;
const toDeg   = r=>r*180/Math.PI;
const dist    = (a,b)=>{
  const R=6371000, Ï†1=toRad(a.lat), Ï†2=toRad(b.lat), Î”Ï†=toRad(b.lat-a.lat), Î”Î»=toRad(b.lng-a.lng);
  const s=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return 2*R*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
};
const bearing = (a,b)=>{
  const Ï†1=toRad(a.lat), Ï†2=toRad(b.lat), Î”Î»=toRad(b.lng-a.lng);
  const y=Math.sin(Î”Î»)*Math.cos(Ï†2); const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  return (toDeg(Math.atan2(y,x))+360)%360;
};
const toXY    = (o,p)=>{
  const d=dist(o,p); const brg=toRad(bearing(o,p));
  return {x: Math.sin(brg)*d, z: Math.cos(brg)*d};
};

async function initCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
  video.srcObject=stream; await video.play();
}
function initThree(){
  renderer=new THREE.WebGLRenderer({canvas,alpha:true});
  renderer.setSize(innerWidth,innerHeight);
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
  camera.position.set(0,1.4,0);
  scene.add(new THREE.AmbientLight(0xffffff,1.1));
  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
}

function initOrientation(){
  window.addEventListener('deviceorientation',(e)=>{
    if(!e.alpha) return; // sensor off / no permission
    const heading=e.webkitCompassHeading||360-e.alpha; // iOS/Android normalisation
    compassNeedle.style.transform=`rotate(${heading}deg)`;
    if(gArrows) gArrows.rotation.y=toRad(-heading);
  });
}

function initGeo(){
  if(!('geolocation' in navigator))
      throw new Error('Geolocation not supported by this device.');

  // Quick first fix (lowâ€‘accuracy, fast)
  navigator.geolocation.getCurrentPosition(pos=>{
      current = { lat: pos.coords.latitude, lng: pos.coords.longitude };

      if(!base){
        base = { ...current };
        geoOK = true;
        tryBuild();
      }

      uiUpdate();
      shiftScene();
  }, err=>{
      console.warn('[geo] quick fix failed', err);
      // We still fall through to highâ€‘accuracy watch below.
  }, {
      enableHighAccuracy:false,
      timeout:5000,
      maximumAge:60000
  });

  // Continuous watch with highâ€‘accuracy for refinement
  const optsHigh = {
      enableHighAccuracy:true,
      timeout:10000,
      maximumAge:3000
  };

  geoWatchId = navigator.geolocation.watchPosition(pos=>{
      current = { lat: pos.coords.latitude, lng: pos.coords.longitude };

      if(!base){
        base = { ...current };
        geoOK = true;
        tryBuild();
      }

      uiUpdate();
      shiftScene();
  }, err=>{
      console.error('[geo] watch error', err);
      if(err.code === err.PERMISSION_DENIED){
         throw new Error('Location permission denied. Enable GPS for AR navigation.');
      }
  }, optsHigh);
}

async function fetchWps(){
  const id=new URLSearchParams(location.search).get('routeId');
  if(!id) throw new Error('Missing ?routeId=â€¦');
  const res=await fetch(API+id); if(!res.ok) throw new Error('Waypoint server error');
  const data=await res.json(); if(!Array.isArray(data.waypoints)||!data.waypoints.length) throw new Error('Route has no wayâ€‘points');
  fetched=data.waypoints; wapOK=true; tryBuild();
}

function meshArrow(){ const g=new THREE.Group();
  const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,1,8),new THREE.MeshLambertMaterial({color:0x00ff40}));
  shaft.rotation.x=Math.PI/2; shaft.position.z=-0.5; g.add(shaft);
  const head=new THREE.Mesh(new THREE.ConeGeometry(0.14,0.25,8),new THREE.MeshLambertMaterial({color:0x00ff40}));
  head.rotation.x=Math.PI/2; head.position.z=-1; g.add(head); return g;
}
function prepareWP(){ wps=[...fetched.map(wp=>({...wp,mesh:meshArrow()})), {lat:base.lat,lng:base.lng}]; }
function buildScene(){ gArrows=new THREE.Group(); wps.forEach(wp=>gArrows.add(wp.mesh)); scene.add(gArrows); }

function shiftScene(){ if(!current) return; const d=toXY(base,current); gArrows.position.set(-d.x*scale,0,-d.z*scale); }
function uiUpdate(){ if(!current||!wps.length) return; const m=dist(current,wps.at(-1)),km=m/1000;
  distanceTime.textContent=`${km<1?Math.round(m)+' m':km.toFixed(1)+' km'} â€¢ ${Math.round(km*2)} min`;
  const ETA=new Date();ETA.setMinutes(ETA.getMinutes()+Math.round(km*2)); eta.textContent=`ETAÂ ${ETA.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`; }

function loop(){ requestAnimationFrame(loop); renderer.render(scene,camera);}()

function tryBuild(){ if(geoOK&&wapOK){ prepareWP(); buildScene(); } }

async function startApp(){
  try{
    await initCamera();
    initThree(); initOrientation(); initGeo();
    await fetchWps();
    loop();
  }catch(e){ overlay.classList.remove('hidden'); pMsg.textContent=e.message; console.error(e); }
}

if(location.protocol!=='https:'){
  pMsg.textContent='This demo requires HTTPS to access sensor & location';
}else{
  startApp();
}

</script>
</body>
</html>
