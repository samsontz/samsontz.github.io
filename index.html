<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Navigation – Waypoint Edition (v5.1 – phone as first WP)</title>

  <!-- Three.js (quick, non-module build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    /* === VISUALS & LAYOUT === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;overflow:hidden}
    #video,#canvas{position:absolute;inset:0;width:100vw;height:100vh}
    #canvas{pointer-events:none;z-index:2}
    #video{object-fit:cover;z-index:1}
    .ui-overlay{position:absolute;z-index:3;font-weight:500}
    .top-bar{top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.7);padding:15px 20px;border-radius:24px;backdrop-filter:blur(8px)}
    .distance-time{font-size:18px;font-weight:600}.eta{opacity:.8;font-size:14px}
    .compass{width:50px;height:50px;border:2px solid rgba(255,255,255,.35);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .compass-needle{width:3px;height:20px;background:#4285f4;border-radius:2px;transform-origin:bottom center;transition:transform .3s}
    .bottom-controls{bottom:24px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center}
    .control-btn{background:rgba(0,0,0,.8);backdrop-filter:blur(8px);border:none;color:#fff;width:54px;height:54px;font-size:24px;border-radius:50%;cursor:pointer;transition:.25s;display:flex;align-items:center;justify-content:center}
    .control-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
    .center-crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;border:2px solid rgba(255,255,255,.6);border-radius:50%;pointer-events:none;z-index:4}
    .center-crosshair::before{content:\"\";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;background:rgba(255,255,255,.85);border-radius:50%}
    .status-indicator{position:absolute;top:92px;right:20px;background:rgba(0,0,0,.8);padding:10px 16px;border-radius:20px;font-size:12px;backdrop-filter:blur(8px)}
    .gps-accuracy{color:#4caf50}.gps-searching{color:#ff9800}

    /* permission overlay */
    #permOverlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:1000}
    #permOverlay.hidden{display:none}
    #permOverlay button{padding:14px 28px;font-size:17px;border:none;border-radius:6px;background:#4285f4;color:#fff;cursor:pointer}
    #permOverlay button:hover{background:#2a6ad3}

    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:.65}}
  </style>
</head>
<body>

  <!-- live camera feed & WebGL overlay -->
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- UI overlays -->
  <div class="center-crosshair"></div>
  <div class="ui-overlay top-bar">
    <div>
      <div id="distanceTime" class="distance-time">—</div>
      <div id="eta" class="eta">Stand by…</div>
    </div>
    <div class="compass"><div id="compassNeedle" class="compass-needle"></div></div>
  </div>
  <div class="ui-overlay bottom-controls">
    <button id="recenterBtn" title="Re-center"  class="control-btn">🔄</button>
    <button id="calibrateBtn" title="Calibrate" class="control-btn">🧭</button>
  </div>
  <div id="statusIndicator" class="ui-overlay status-indicator">
    <span class="gps-searching">📡 Searching GPS…</span>
  </div>

  <!-- permission prompt -->
  <div id="permOverlay">
    <h2 style="max-width:320px;text-align:center">
      This AR demo needs your camera, location and motion sensors.
    </h2>
    <p id="permMessage" style="max-width:320px;text-align:center"></p>
    <button id="permBtn">Grant permissions</button>
  </div>

<script>
/* ---------- helpers ---------- */
const EARTH_R = 6371e3, DEG = Math.PI/180;
const geoDist = (a,b) => {
  const φ1=a.lat*DEG, φ2=b.lat*DEG, dφ=(b.lat-a.lat)*DEG, dλ=(b.lng-a.lng)*DEG;
  const h=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  return 2*EARTH_R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
};
const geoToXY = (o,p) => {
  const meanLat=(o.lat+p.lat)/2*DEG;
  return {
    x: EARTH_R*(p.lng-o.lng)*DEG*Math.cos(meanLat),
    z: EARTH_R*(p.lat-o.lat)*DEG
  };
};

/* ---------- config ---------- */
const API_ROOT='https://waypoints-prht.onrender.com/get-waypoints/';

/* ---------- state ---------- */
let renderer,scene,camera,arrowGroup;
let currentPos=null, basePos=null;
let fetched=[], wps=[];
let pathScale = 0.08;
let readyGeo=false, readyWps=false;

/* ---------- permission overlay ---------- */
const overlay=document.getElementById('permOverlay');
const permMsg=document.getElementById('permMessage');
document.getElementById('permBtn').onclick=requestPermissions;

async function requestPermissions(){
  try{
    permMsg.textContent='Requesting camera…';
    await navigator.mediaDevices.getUserMedia({video:true});

    permMsg.textContent='Requesting location…';
    await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));

    if (DeviceOrientationEvent?.requestPermission) {
      permMsg.textContent='Requesting motion sensors…';
      await DeviceOrientationEvent.requestPermission();
    }
    overlay.classList.add('hidden');
    init();
  }catch(e){
    permMsg.textContent='Permission denied. Please allow permissions in browser settings.';
    console.error(e);
  }
}

/* ---------- camera ---------- */
async function initCamera(){
  const video=document.getElementById('video');

  async function tryStream(constraints){
    try{
      const stream=await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=stream;
      await new Promise(r=>video.onloadedmetadata=r);
      await video.play();
      return true;
    }catch(e){console.warn('getUserMedia failed:',e);return false;}
  }

  const ok = await tryStream({video:{facingMode:{exact:'environment'}}}) ||
             await tryStream({video:{facingMode:{ideal:'environment'}}}) ||
             await tryStream({video:true});
  if(!ok) throw new Error('Camera unavailable or permission denied');
}

/* ---------- three.js ---------- */
function initThree(){
  renderer=new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),alpha:true,antialias:true});
  renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(devicePixelRatio);
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.01,1000);
  camera.position.set(0,1.6,0);
  scene.add(new THREE.AmbientLight(0xffffff,0.8));
  const dl=new THREE.DirectionalLight(0xffffff,0.7);dl.position.set(15,25,8);scene.add(dl);
  arrowGroup=new THREE.Group();scene.add(arrowGroup);
}

/* ---------- orientation ---------- */
function initOrientation(){
  const handle=(e)=>{
    const alpha=e.alpha||0,beta=e.beta||0;
    document.getElementById('compassNeedle').style.transform=`rotate(${360-alpha}deg)`;
    camera.rotation.set(beta*DEG,alpha*DEG,0,'YXZ');
  };
  if(DeviceOrientationEvent?.requestPermission){
    DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')addEventListener('deviceorientation',handle);});
  }else addEventListener('deviceorientation',handle);
}

/* ---------- geolocation ---------- */
function initGeolocation(){
  navigator.geolocation.watchPosition(p=>{
    currentPos={lat:p.coords.latitude,lng:p.coords.longitude};
    if(!basePos){basePos={...currentPos};readyGeo=true;buildIfReady();}
    updateHUD();shiftScene();
  },err=>console.error(err),{enableHighAccuracy:true,timeout:10000,maximumAge:3000});
}

/* ---------- fetch waypoints ---------- */
async function loadWaypoints(){
  const id=new URLSearchParams(location.search).get('routeId');
  if(!id) return [];
  const data=await (await fetch(API_ROOT+id)).json();
  return Array.isArray(data.waypoints)?data.waypoints:[];
}

/* ---------- path + arrows ---------- */
function arrowMesh(){
  const g=new THREE.Group();
  const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.9,8),new THREE.MeshLambertMaterial({color:0x00ff40}));
  shaft.rotation.x=Math.PI/2;shaft.position.z=0.45;g.add(shaft);
  const head=new THREE.Mesh(new THREE.ConeGeometry(0.14,0.28,12),new THREE.MeshLambertMaterial({color:0xff2020}));
  head.rotation.x=Math.PI/2;head.position.z=0.9;g.add(head);
  g.userData={pulse:Math.random()*Math.PI*2};
  return g;
}
function pinMesh(){
  const g=new THREE.Group(), redM=new THREE.MeshLambertMaterial({color:0xc41230,emissive:0xc41230});
  const cyl=new THREE.Mesh(new THREE.CylinderGeometry(0.45,0.35,0.6,6),redM);
  const core=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.1,6),new THREE.MeshLambertMaterial({color:0xffffff}));
  core.position.y=0.33;
  const tip=new THREE.Mesh(new THREE.ConeGeometry(0.12,0.45,14),redM);
  tip.position.y=-0.45;
  g.add(cyl,core,tip);return g;
}
/* convert to local coords, prepend phone position */
function prepareWaypoints(){
  const rel=(p)=>({...p,rel:geoToXY(basePos,p)});
  wps=[{lat:basePos.lat,lng:basePos.lng,rel:{x:0,z:0}}].concat(fetched.map(rel));
}
/* build arrows + destination pin */
function buildScene(){
  arrowGroup.clear();
  if(wps.length<2) return;
  const far=Math.max(...wps.map(p=>Math.hypot(p.rel.x,p.rel.z)));
  pathScale = 25/Math.max(far,25);

  // destination pin
  const dst=wps.at(-1).rel;
  const pin=pinMesh();pin.scale.setScalar(2*pathScale);pin.position.set(dst.x*pathScale,0,dst.z*pathScale);
  arrowGroup.add(pin);

  for(let i=0;i<wps.length-1;i++){
    const a=wps[i].rel,b=wps[i+1].rel,dx=b.x-a.x,dz=b.z-a.z,len=Math.hypot(dx,dz),yaw=Math.atan2(dx,dz);
    const count=Math.max(3,Math.floor(len/8));
    for(let j=0;j<count;j++){
      const t=(j+0.5)/count;
      const m=arrowMesh();
      m.rotation.y=-yaw;
      m.scale.setScalar(4*pathScale);
      m.position.set((a.x+dx*t)*pathScale,0.03,(a.z+dz*t)*pathScale);
      arrowGroup.add(m);
    }
  }
  shiftScene();
}

/* ---------- dynamic scene shift ---------- */
function shiftScene(){
  if(!currentPos||!basePos) return;
  const d=geoToXY(basePos,currentPos);
  arrowGroup.position.set(-d.x*pathScale,0,-d.z*pathScale);
}

/* ---------- HUD ---------- */
function updateHUD(){
  if(!currentPos||!wps.length) return;
  const m=geoDist(currentPos,wps.at(-1)), km=m/1000;
  document.getElementById('distanceTime').textContent=`${km<1?Math.round(m)+' m':km.toFixed(1)+' km'} • ${Math.round(km*2)} min`;
  const eta=new Date();eta.setMinutes(eta.getMinutes()+Math.round(km*2));
  document.getElementById('eta').textContent=`ETA ${eta.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
}

/* ---------- render loop ---------- */
function animate(){
  requestAnimationFrame(animate);
  arrowGroup.children.forEach(m=>{
    if(m.userData?.pulse!==undefined){
      m.userData.pulse+=0.04;
      m.scale.y=(1+0.25*Math.sin(m.userData.pulse))*4*pathScale;
    }
  });
  renderer.render(scene,camera);
}

/* ---------- UI ---------- */
function initUI(){
  addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
  document.getElementById('recenterBtn').onclick=()=>camera.position.set(0,1.6,0);
}

/* ---------- orchestrate ---------- */
function buildIfReady(){
  if(readyGeo&&readyWps){
    prepareWaypoints();
    buildScene();
    animate();
  }
}
async function init(){
  try{
    await initCamera();
    initThree();
    initOrientation();
    initGeolocation();
    initUI();
    fetched=await loadWaypoints();
    readyWps=true;
    buildIfReady();
  }catch(e){
    overlay.classList.remove('hidden');
    permMsg.textContent='Error: '+e.message;
    console.error(e);
  }
}

/* ---------- start overlay message ---------- */
permMsg.textContent=location.protocol==='https:'?
  'Tap “Grant permissions” then allow requests.' :
  'This page must be served over HTTPS.';
if(location.protocol!=='https:') document.getElementById('permBtn').style.display='none';
</script>
</body>
</html>
