<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ARÂ NavigationÂ â€“Â Waypoint EditionÂ (v7Â â€¢ logicâ€‘fix)</title>

  <!-- Three.js (quick nonâ€‘module build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    /* ------------ UI & layout ------------ */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;overflow:hidden}
    #video,#canvas{position:absolute;inset:0;width:100vw;height:100vh}
    #canvas{pointer-events:none;z-index:2}
    #video{object-fit:cover;z-index:1}

    .ui-overlay{position:absolute;z-index:3;font-weight:500}
    .top-bar{top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.7);padding:14px 20px;border-radius:22px;backdrop-filter:blur(8px)}
    .distance-time{font-size:18px;font-weight:600}.eta{font-size:14px;opacity:.8}
    .compass{width:50px;height:50px;border:2px solid rgba(255,255,255,.35);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .compass-needle{width:3px;height:20px;background:#4285f4;border-radius:2px;transform-origin:bottom center;transition:transform .3s}
    .bottom-controls{bottom:22px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center}
    .control-btn{background:rgba(0,0,0,.8);backdrop-filter:blur(8px);border:none;color:#fff;width:54px;height:54px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:25px;transition:.25s}
    .control-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}
    .center-crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;border:2px solid rgba(255,255,255,.6);border-radius:50%;z-index:4;pointer-events:none}
    .center-crosshair::before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;background:rgba(255,255,255,.85);border-radius:50%}
    .status-indicator{position:absolute;top:92px;right:20px;background:rgba(0,0,0,.8);padding:9px 16px;border-radius:18px;font-size:12px;backdrop-filter:blur(8px)}
    .gps-accuracy{color:#4caf50}.gps-searching{color:#ff9800}

    /* ---------- permission overlay ---------- */
    #permOverlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:22px;z-index:1000}
    #permOverlay.hidden{display:none}
    #permOverlay button{padding:14px 28px;font-size:17px;border:none;border-radius:6px;background:#4285f4;color:#fff;cursor:pointer}
    #permOverlay button:hover{background:#2a6ad3}
  </style>
</head>
<body>

  <!-- rearâ€‘camera feed & three.js overlay -->
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- overlays -->
  <div class="center-crosshair"></div>
  <div class="ui-overlay top-bar">
    <div>
      <div id="distanceTime" class="distance-time">â€”</div>
      <div id="eta" class="eta">StandÂ byâ€¦</div>
    </div>
    <div class="compass"><div id="compassNeedle" class="compass-needle"></div></div>
  </div>
  <div class="ui-overlay bottom-controls">
    <button id="recenterBtn" class="control-btn" title="Reâ€‘center">ðŸ”„</button>
    <button id="calibrateBtn" class="control-btn" title="Calibrate">ðŸ§­</button>
  </div>
  <div id="statusIndicator" class="ui-overlay status-indicator"><span class="gps-searching">ðŸ“¡Â SearchingÂ GPSâ€¦</span></div>

  <!-- permission modal -->
  <div id="permOverlay">
    <h2 style="max-width:320px;text-align:center">This AR demo needs your <strong>rear camera</strong>, location and motion sensors.</h2>
    <p id="permMsg" style="max-width:320px;text-align:center"></p>
    <button id="permBtn">Grant permissions</button>
  </div>

<script>
/******************************************************************************
 *  BASIC GEO / MATH HELPERS                                                  *
 *****************************************************************************/
const R = 6371e3, DEG = Math.PI/180;
const dist = (a,b)=>{const Ï†1=a.lat*DEG,Ï†2=b.lat*DEG,dÏ†=(b.lat-a.lat)*DEG,dÎ»=(b.lng-a.lng)*DEG;const h=Math.sin(dÏ†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2;return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));};
const toXY = (o,p)=>{const ml=(o.lat+p.lat)/2*DEG;return{x:R*(p.lng-o.lng)*DEG*Math.cos(ml),z:R*(p.lat-o.lat)*DEG};};

/******************************************************************************
 *  GLOBAL STATE                                                              *
 *****************************************************************************/
let renderer, scene, camera, gArrows;
let current=null, base=null;              // gps points
let fetched=[],   wps=[];                 // server + merged wayâ€‘points
let scale=0.1;                            // metres â†’ scene units
let geoOK=false, wapOK=false;

const API = 'https://waypoints-prht.onrender.com/get-waypoints/';

/******************************************************************************
 *  PERMISSION OVERLAY                                                        *
 *****************************************************************************/
const overlay = document.getElementById('permOverlay');
const pMsg    = document.getElementById('permMsg');
document.getElementById('permBtn').onclick = async ()=>{
  try{
    pMsg.textContent='Requesting rear cameraâ€¦';
    await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}}});

    pMsg.textContent='Requesting locationâ€¦';
    await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));

    if(typeof DeviceOrientationEvent!=='undefined' && DeviceOrientationEvent.requestPermission){
      pMsg.textContent='Requesting motion sensorsâ€¦';
      await DeviceOrientationEvent.requestPermission();
    }

    overlay.classList.add('hidden');
    startApp();
  }catch(e){pMsg.textContent=e.message||'Permission denied';console.error(e);}  
};

/******************************************************************************
 *  CAMERA                                                                    *
 *****************************************************************************/
async function initCamera(){
  const v=document.getElementById('video');
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}}});
  v.srcObject=stream; await new Promise(r=>v.onloadedmetadata=r); await v.play();
}

/******************************************************************************
 *  THREE.JS                                                                  *
 *****************************************************************************/
function initThree(){
  renderer=new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),alpha:true,antialias:true});
  renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(devicePixelRatio);
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.05,1000);
  camera.position.set(0,1.6,0);
  scene.add(new THREE.AmbientLight(0xffffff,0.85));
  const dl=new THREE.DirectionalLight(0xffffff,0.7);dl.position.set(10,25,5);scene.add(dl);
  gArrows=new THREE.Group();scene.add(gArrows);
  // keep renderer in sync with screen size
  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
}

/******************************************************************************
 *  DEVICE ORIENTATION                                                        *
 *****************************************************************************/
function initOrientation(){
  const needle=document.getElementById('compassNeedle');
  window.addEventListener('deviceorientation',e=>{
    // Some browsers (notably iOS) provide webkitCompassHeading (0 = north, clockwise) ðŸ“±
    const heading=(e.webkitCompassHeading!=null)?e.webkitCompassHeading: (e.alpha||0);
    const pitch=e.beta||0;
    needle.style.transform=`rotate(${360-heading}deg)`;
    // Convert to radians (Three.js expects yaw around Y, pitch around X)
    camera.rotation.set(pitch*DEG, -heading*DEG, 0,'YXZ');
  });
}

/******************************************************************************
 *  GEOLOCATION (watch)                                                       *
 *****************************************************************************/
function initGeo(){
  navigator.geolocation.watchPosition(pos=>{
    current={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(!base){base={...current};geoOK=true;tryBuild();}
    uiUpdate(); shiftScene();
  },err=>console.error(err),{enableHighAccuracy:true,timeout:10000,maximumAge:3000});
}

/******************************************************************************
 *  FETCH WAYâ€‘POINTS FROM SERVER                                              *
 *****************************************************************************/
async function fetchWps(){
  const id=new URLSearchParams(location.search).get('routeId');
  if(!id) throw new Error('Missing ?routeId=â€¦');
  const res=await fetch(API+id); if(!res.ok) throw new Error('Waypoint server error');
  const data=await res.json(); if(!Array.isArray(data.waypoints)||!data.waypoints.length) throw new Error('Route has no wayâ€‘points');
  fetched=data.waypoints; wapOK=true; tryBuild();
}

/******************************************************************************
 *  SCENE BUILDING                                                            *
 *****************************************************************************/
function meshArrow(){ const g=new THREE.Group();
  const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,1,8),new THREE.MeshLambertMaterial({color:0x00ff40}));
  shaft.rotation.x=Math.PI/2;shaft.position.z=0.5;g.add(shaft);
  const head=new THREE.Mesh(new THREE.ConeGeometry(0.14,0.3,12),new THREE.MeshLambertMaterial({color:0xff2020}));head.rotation.x=Math.PI/2;head.position.z=1;g.add(head);
  return g; }
function meshPin(){const g=new THREE.Group(),m=new THREE.MeshLambertMaterial({color:0xd20,emissive:0xd20});
  const t=new THREE.Mesh(new THREE.ConeGeometry(0.15,0.45,14),m);t.rotation.x=Math.PI;g.add(t);return g;}

function prepareWP(){ wps=[{lat:base.lat,lng:base.lng,rel:{x:0,z:0}}].concat(fetched.map(p=>({...p,rel:toXY(base,p)}))); }

function buildScene(){ gArrows.clear(); if(wps.length<2)return;
  const far=Math.max(...wps.map(p=>Math.hypot(p.rel.x,p.rel.z))); scale=25/Math.max(far,25);
  // dest pin
  const pin=meshPin(); const d=wps.at(-1).rel; pin.position.set(d.x*scale,0,d.z*scale); pin.scale.setScalar(1.8*scale); gArrows.add(pin);
  // arrows per segment
  for(let i=0;i<wps.length-1;i++){const A=wps[i].rel,B=wps[i+1].rel,dx=B.x-A.x,dz=B.z-A.z,len=Math.hypot(dx,dz),yaw=Math.atan2(dx,dz);
    const n=Math.max(3,Math.floor(len/8));
    for(let j=0;j<n;j++){const t=(j+0.5)/n;const a=meshArrow();a.position.set((A.x+dx*t)*scale,0,(A.z+dz*t)*scale);a.rotation.y=-yaw;a.scale.setScalar(4*scale);gArrows.add(a);} }
  shiftScene(); }

function shiftScene(){ if(!current) return; const d=toXY(base,current); gArrows.position.set(-d.x*scale,0,-d.z*scale); }

/******************************************************************************
 *  UI UPDATE & RENDER LOOP                                                   *
 *****************************************************************************/
function uiUpdate(){ if(!current||!wps.length) return; const m=dist(current,wps.at(-1)),km=m/1000;
  distanceTime.textContent=`${km<1?Math.round(m)+' m':km.toFixed(1)+' km'} â€¢ ${Math.round(km*2)} min`;
  const ETA=new Date();ETA.setMinutes(ETA.getMinutes()+Math.round(km*2)); eta.textContent=`ETA ${ETA.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`; }

function renderLoop(){
  requestAnimationFrame(renderLoop);
  if(renderer && scene && camera){ renderer.render(scene,camera); }
}

/******************************************************************************
 *  BUILD WHEN READY                                                          *
 *****************************************************************************/
function tryBuild(){ if(geoOK&&wapOK){prepareWP();buildScene();} }

/******************************************************************************
 *  APP START                                                                 *
 *****************************************************************************/
async function startApp(){
  try{
    await initCamera();
    initThree(); initOrientation(); initGeo();
    await fetchWps();
    renderLoop();
  }catch(e){overlay.classList.remove('hidden');pMsg.textContent=e.message;console.error(e);}
}

/******************************************************************************
 *  HTTPS REQUIREMENT NOTICE                                                  *
 *****************************************************************************/
if(location.protocol!=='https:'){
  pMsg.textContent='This demo requires HTTPS to access sensors.';
  document.getElementById('permBtn').style.display='none';
}
</script>
</body>
</html>
