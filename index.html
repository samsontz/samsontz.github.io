<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR¬†Navigation¬†‚Äì Waypoint¬†Edition¬†(v5 ‚Äì phone¬†as¬†first¬†WP)</title>

  <!-- Three.js (non‚Äëmodule build) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    /* === VISUALS & LAYOUT === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;overflow:hidden}
    #video,#canvas{position:absolute;inset:0;width:100vw;height:100vh}
    #canvas{pointer-events:none;z-index:2}
    #video{object-fit:cover;z-index:1}
    .ui-overlay{position:absolute;z-index:3;font-weight:500}
    .top-bar{top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.7);padding:15px 20px;border-radius:24px;backdrop-filter:blur(8px)}
    .distance-time{font-size:18px;font-weight:600}.eta{opacity:.8;font-size:14px}
    .compass{width:50px;height:50px;border:2px solid rgba(255,255,255,.35);border-radius:50%;display:flex;align-items:center;justify-content:center}
    .compass-needle{width:3px;height:20px;background:#4285f4;border-radius:2px;transform-origin:bottom center;transition:transform .3s}
    .bottom-controls{bottom:24px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center}
    .control-btn{background:rgba(0,0,0,.8);backdrop-filter:blur(8px);border:none;color:#fff;width:54px;height:54px;font-size:24px;border-radius:50%;cursor:pointer;transition:.25s;display:flex;align-items:center;justify-content:center}
    .control-btn:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
    .center-crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;border:2px solid rgba(255,255,255,.6);border-radius:50%;pointer-events:none;z-index:4}
    .center-crosshair::before{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;background:rgba(255,255,255,.85);border-radius:50%}
    .status-indicator{position:absolute;top:92px;right:20px;background:rgba(0,0,0,.8);padding:10px 16px;border-radius:20px;font-size:12px;backdrop-filter:blur(8px)}
    .gps-accuracy{color:#4caf50}.gps-searching{color:#ff9800}

    /* permission overlay  */
    #permOverlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:1000}
    #permOverlay.hidden{display:none}
    #permOverlay button{padding:14px 28px;font-size:17px;border:none;border-radius:6px;background:#4285f4;color:#fff;cursor:pointer}
    #permOverlay button:hover{background:#2a6ad3}

    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:.65}}
  </style>
</head>
<body>

  <!-- live camera feed & WebGL overlay -->
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- UI overlays -->
  <div class="center-crosshair"></div>
  <div class="ui-overlay top-bar">
    <div><div id="distanceTime" class="distance-time">‚Äî</div><div id="eta" class="eta">Stand¬†by‚Ä¶</div></div>
    <div class="compass"><div id="compassNeedle" class="compass-needle"></div></div>
  </div>
  <div class="ui-overlay bottom-controls">
    <button id="recenterBtn" title="Re‚Äëcenter"  class="control-btn">üîÑ</button>
    <button id="calibrateBtn" title="Calibrate" class="control-btn">üß≠</button>
  </div>
  <div id="statusIndicator" class="ui-overlay status-indicator"><span class="gps-searching">üì°¬†Searching¬†GPS‚Ä¶</span></div>

  <!-- permission prompt -->
  <div id="permOverlay" class="hidden">
    <h2 style="max-width:320px;text-align:center">This AR demo needs your camera, location and motion sensors.</h2>
    <p id="permMessage" style="max-width:320px;text-align:center"></p>
    <button id="permBtn">Grant permissions</button>
  </div>

  <!---------------------  MAIN SCRIPT  ----------------------------->
  <script>
  /*¬†üåç¬†Coordinate helpers */
  const EARTH_R = 6371e3, deg2rad=v=>v*Math.PI/180;
  const geoDist=(a,b)=>{const f1=deg2rad(a.lat),f2=deg2rad(b.lat),dF=deg2rad(b.lat-a.lat),dL=deg2rad(b.lng-a.lng);const h=Math.sin(dF/2)**2+Math.cos(f1)*Math.cos(f2)*Math.sin(dL/2)**2;return 2*EARTH_R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));};
  const geoToLocal=(o,p)=>{const f=(deg2rad(o.lat)+deg2rad(p.lat))/2;return{ x:EARTH_R*deg2rad(p.lng-o.lng)*Math.cos(f), z:EARTH_R*deg2rad(p.lat-o.lat) };};

  /* Backend */
  const API_ROOT='https://waypoints-prht.onrender.com/get-waypoints/';

  /* Globals */
  let renderer,scene,camera,arrowGroup;
  let currentPos=null, firstFix=false;
  let basePos=null;          // phone‚Äôs initial location ‚Üí new path origin
  let fetched=[], wps=[];    // original + with base
  let pathScale=0.08;
  let readyGeo=false, readyWps=false;

  /* -------- permission overlay ---------- */
  const overlay=document.getElementById('permOverlay');
  const permMsg=document.getElementById('permMessage');
  document.getElementById('permBtn').onclick=requestPerms;
  async function requestPerms(){
    try{
      permMsg.textContent='Requesting camera‚Ä¶';
      await navigator.mediaDevices.getUserMedia({video:true});
      permMsg.textContent='Requesting location‚Ä¶';
      await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej));
      if(DeviceOrientationEvent?.requestPermission){permMsg.textContent='Requesting motion sensors‚Ä¶';await DeviceOrientationEvent.requestPermission();}
      overlay.classList.add('hidden');
      bootstrap();
    }catch(e){permMsg.textContent='Permission denied. Adjust your browser settings.';console.error(e);} }

  /* ---------- camera + three ----------- */
  async function initCamera(){
    const v=document.getElementById('video');
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    v.srcObject=stream; await new Promise(r=>v.onloadedmetadata=r); try{await v.play();}catch(e){}
  }
  function initThree(){
    renderer=new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),alpha:true,antialias:true});
    renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(devicePixelRatio);
    scene=new THREE.Scene();
    camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.01,1000);
    camera.position.set(0,1.6,0);
    scene.add(new THREE.AmbientLight(0xffffff,0.8));const dl=new THREE.DirectionalLight(0xffffff,0.7);dl.position.set(15,25,8);scene.add(dl);
    arrowGroup=new THREE.Group();scene.add(arrowGroup);
  }

  /* -------- orientation ---------- */
  function initOrientation(){
    const cb=e=>{const a=e.alpha||0,b=e.beta||0;document.getElementById('compassNeedle').style.transform=`rotate(${360-a}deg)`;camera.rotation.set(b*deg2rad(1),a*deg2rad(1),0,'YXZ');};
    if(DeviceOrientationEvent?.requestPermission){DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')addEventListener('deviceorientation',cb);});}
    else addEventListener('deviceorientation',cb);
  }

  /* ---------- GPS ---------- */
  function initGeolocation(){
    navigator.geolocation.watchPosition(pos=>{
      currentPos={lat:pos.coords.latitude,lng:pos.coords.longitude,acc:pos.coords.accuracy};
      updateStatus(pos.coords.accuracy);
      if(!firstFix){firstFix=true;basePos={...currentPos};readyGeo=true;tryStart();}
      updateHUD();shiftScene();
    },err=>{updateStatus(null,'GPS error');console.error(err);},{enableHighAccuracy:true,maximumAge:3000,timeout:10000});
  }
  function updateStatus(acc,msg){const el=document.getElementById('statusIndicator');if(msg){el.innerHTML='<span class="gps-searching">'+msg+'</span>';return;}el.innerHTML=acc<12?'<span class="gps-accuracy">üìç¬†GPS OK</span>':'<span class="gps-searching">üì°¬†Low accuracy</span>';}

  /* ---------- waypoints ---------- */
  async function fetchWaypoints(){
    const id=new URLSearchParams(location.search).get('routeId'); if(!id)return[];
    const data=await (await fetch(API_ROOT+id)).json(); return Array.isArray(data.waypoints)?data.waypoints:[];
  }
  function buildWpList(){
    const rel=(p)=>({...p,rel:geoToLocal(basePos,p)});
    wps=[ {lat:basePos.lat,lng:basePos.lng,rel:{x:0,z:0},type:'origin'}, ...fetched.map(rel) ];
  }

  /* ---------- 3‚ÄëD factories ---------- */
  function mkArrow(){const g=new THREE.Group();const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.9,8),new THREE.MeshLambertMaterial({color:0x00ff40}));shaft.rotation.x=Math.PI/2;shaft.position.z=0.45;g.add(shaft);const head=new THREE.Mesh(new THREE.ConeGeometry(0.14,0.28,12),new THREE.MeshLambertMaterial({color:0xff2020}));head.rotation.x=Math.PI/2;head.position.z=0.9;g.add(head);g.userData={t:Math.random()*6.28};return g;}
  function mkPin(){const g=new THREE.Group();const m=new THREE.MeshLambertMaterial({color:0xc41230,emissive:0xc41230});const cyl=new THREE.Mesh(new THREE.CylinderGeometry(0.45,0.35,0.6,6),m);const core=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.1,6),new THREE.MeshLambertMaterial({color:0xffffff}));core.position.y=0.33;const tip=new THREE.Mesh(new THREE.ConeGeometry(0.12,0.45,14),m);tip.position.y=-0.45;g.add(cyl,core,tip);return g;}

  /* ---------- build scene ---------- */
  function buildScene(){arrowGroup.clear();if(wps.length<2)return;
    // scale heuristically to keep within view
    const far=Math.max(...wps.map(p=>Math.hypot(p.rel.x,p.rel.z)));pathScale=25/Math.max(25,far);
    // destination pin
    const dst=wps.at(-1).rel;const pin=mkPin();pin.scale.setScalar(2*pathScale);pin.position.set(dst.x*pathScale,0,dst.z*pathScale);arrowGroup.add(pin);
    // arrows along each segment
    for(let i=0;i<wps.length-1;i++){
      const a=wps[i].rel,b=wps[i+1].rel,dx=b.x-a.x,dz=b.z-a.z,len=Math.hypot(dx,dz),yaw=Math.atan2(dx,dz);
      const count=Math.max(3,Math.floor(len/8));
      for(let j=0;j<count;j++){const t=(j+0.5)/count;const arr=mkArrow();arr.rotation.y=-yaw;arr.scale.setScalar(4*pathScale);arr.position.set((a.x+dx*t)*pathScale,0.03,(a.z+dz*t)*pathScale);arrowGroup.add(arr);} }
    shiftScene();
  }

  /* ---------- dynamic shift ---------- */
  function shiftScene(){ if(!currentPos||!basePos)return; const d=geoToLocal(basePos,currentPos); arrowGroup.position.set(-d.x*pathScale,0,-d.z*pathScale); }

  /* ---------- HUD ---------- */
  function updateHUD(){if(!currentPos||!wps.length)return;const m=geoDist(currentPos,wps.at(-1));const km=m/1000;document.getElementById('distanceTime').textContent=`${km<1?Math.round(m)+'¬†m':km.toFixed(1)+'¬†km'} ‚Ä¢ ${Math.round(km*2)}¬†min`;const eta=new Date();eta.setMinutes(eta.getMinutes()+Math.round(km*2));document.getElementById('eta').textContent=`ETA ${eta.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;}

  /* ---------- render loop ---------- */
  function render(){requestAnimationFrame(render);arrowGroup.children.forEach(a=>{if(a.userData){a.userData.t+=0.05;a.scale.y=(1+0.22*Math.sin(a.userData.t))*4*pathScale;}});renderer.render(scene,camera);}  

  /* ---------- UI ---------- */
  function initUI(){addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});document.getElementById('recenterBtn').onclick=()=>camera.position.set(0,1.6,0);}  

  /* ---------- orchestrate ---------- */
  function tryStart(){ if(readyGeo&&readyWps){ buildWpList(); buildScene(); render(); } }

  async function bootstrap(){ try{
      await initCamera(); initThree(); initOrientation(); initGeolocation(); initUI();
      fetched=await fetchWaypoints(); readyWps=true; tryStart();
    }catch(e){console.error(e);overlay.classList.remove('hidden');permMsg.textContent='Error: '+e.message;}
  }

  // overlay auto-show
  permMsg.textContent=location.protocol==='https:'?'Tap button then allow permissions.':'This page must run over HTTPS.';
  if(location.protocol!=='https:')document.getElementById('permBtn').style.display='none';
  </script>
</body>
</html>
