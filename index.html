<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Navigation</title>
  <style>
    :root {
      --bg-glass: rgba(0,0,0,0.45);
      --txt-light: #fff;
      --txt-accent: #0ff;
    }
    html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Arial,sans-serif;color:var(--txt-light);}
    #xr-canvas{position:fixed;inset:0;width:100%;height:100%;touch-action:none;}
    .overlay{position:fixed;left:0;right:0;z-index:10;pointer-events:none;}
    #toolbar{top:0;display:flex;gap:.5rem;align-items:center;padding:.5rem 1rem;background:var(--bg-glass);backdrop-filter:blur(6px);}
    #toolbar button{pointer-events:auto;border:none;padding:.4rem .8rem;border-radius:.5rem;background:var(--txt-accent);color:#000;font-weight:600;cursor:pointer;}
    #status{flex:1;text-align:center;font-size:.9rem;font-weight:500;}

    /* Heads‑up display always on */
    #hud{top:2.8rem;display:flex;justify-content:space-between;align-items:flex-start;padding:0 1rem;pointer-events:none;}
    #topCenter{font-size:1.25rem;font-weight:600;text-shadow:0 0 6px #000;}
    #topRight{font-size:1.25rem;font-weight:600;text-shadow:0 0 6px #000;}
    #guidance{bottom:1.5rem;left:50%;transform:translateX(-50%);max-width:90%;padding:.75rem 1rem;background:var(--bg-glass);border-radius:1rem;font-size:1.1rem;text-align:center;backdrop-filter:blur(8px);}
  </style>
  <!-- Three.js import map -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <canvas id="xr-canvas"></canvas>

  <!-- Toolbar -->
  <div id="toolbar" class="overlay">
    <button id="startBtn" disabled>Start AR Navigation</button>
    <button id="stopBtn" hidden>Stop Navigation</button>
    <span id="status">Initializing GPS…</span>
  </div>

  <!-- Always‑visible HUD (distance, ETA, next turn) -->
  <div id="hud" class="overlay">
    <div id="topCenter"><span id="distanceText">-- m</span> • <span id="etaText">-- min</span></div>
    <div id="topRight"><span id="turnText">—</span></div>
  </div>

  <!-- Guidance banner -->
  <div id="guidance" class="overlay" hidden></div>

  <script type="module">
    import * as THREE from 'three';
    import { XRButton } from 'three/addons/webxr/XRButton.js';

    /***  Constants & DOM refs  ***/
    const R_EARTH = 6378137; // metres, WGS‑84
    const DEG2RAD = Math.PI/180;
    const WALK_H_MPS = 1.4; // assumed walking speed

    const canvas = document.getElementById('xr-canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const guidanceEl = document.getElementById('guidance');
    const distanceEl = document.getElementById('distanceText');
    const etaEl = document.getElementById('etaText');
    const turnEl = document.getElementById('turnText');

    /***  Three.js scene  ***/
    const renderer = new THREE.WebGLRenderer({canvas,alpha:true,antialias:true});
    renderer.xr.enabled = true;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera();
    const worldRoot = new THREE.Group();
    scene.add(worldRoot);
    scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

    /***  Route & state  ***/
    let originLLA = null;               // first averaged fix
    let userLLA = null;                 // live, smoothed
    let waypointsLLA = [];              // [{lat,lng,alt}]
    let waypointsENU = [];              // THREE.Vector3 list
    let nextWpIdx = 1;                  // index of upcoming waypoint
    let lineMesh = null;

    /***  Heading  ***/
    let headingDeg = 0;
    let headingAtXRStart = null;

    /***  Utility functions  ***/
    const llaToENU = ({lat,lng,alt=0})=>{
      const dLat = (lat - originLLA.lat) * DEG2RAD;
      const dLon = (lng - originLLA.lng) * DEG2RAD;
      const east  = dLon * Math.cos(originLLA.lat*DEG2RAD) * R_EARTH;
      const north = dLat * R_EARTH;
      const up    = alt - originLLA.alt;
      return new THREE.Vector3(east, up, north);
    };

    const haversineDistance = (a,b)=>{
      const dLat = (b.lat-a.lat)*DEG2RAD;
      const dLon = (b.lng-a.lng)*DEG2RAD;
      const lat1=a.lat*DEG2RAD, lat2=b.lat*DEG2RAD;
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R_EARTH*Math.asin(Math.sqrt(h));
    };

    const bearingDeg = (a,b)=>{
      const lat1=a.lat*DEG2RAD, lat2=b.lat*DEG2RAD;
      const dLon=(b.lng-a.lng)*DEG2RAD;
      const y=Math.sin(dLon)*Math.cos(lat2);
      const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      return (Math.atan2(y,x)*180/Math.PI+360)%360;
    };

    const compassPoints=['north','north‑east','east','south‑east','south','south‑west','west','north‑west'];
    const bearingToCompass = brg => compassPoints[Math.round(brg/45)%8];

    /***  Geolocation watcher with simple smoothing  ***/
    const fixBuf=[];
    navigator.geolocatio
