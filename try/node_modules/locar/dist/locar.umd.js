(function(s,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],r):(s=typeof globalThis<"u"?globalThis:s||self,r(s.locar={},s.THREE))})(this,function(s,r){"use strict";var q=s=>{throw TypeError(s)};var _=(s,r,h)=>r.has(s)||q("Cannot "+h);var i=(s,r,h)=>(_(s,r,"read from private field"),h?h.call(s):r.get(s)),u=(s,r,h)=>r.has(s)?q("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(s):r.set(s,h),c=(s,r,h,o)=>(_(s,r,"write to private field"),o?o.call(s,h):r.set(s,h),h),m=(s,r,h)=>(_(s,r,"access private method"),h);var I=(s,r,h,o)=>({set _(C){c(s,r,C,h)},get _(){return i(s,r,o)}});var f,F,N,G,z,P,E,y,D,A,O,p,T,b,v,g,S,k,x,Q;function h(M){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(M){for(const t in M)if(t!=="default"){const n=Object.getOwnPropertyDescriptor(M,t);Object.defineProperty(e,t,n.get?n:{enumerable:!0,get:()=>M[t]})}}return e.default=M,Object.freeze(e)}const o=h(r);class C{constructor(){u(this,f);this.EARTH=4007501668e-2,this.HALF_EARTH=2003750834e-2}project(e,t){return[m(this,f,F).call(this,e),m(this,f,N).call(this,t)]}unproject(e){return[m(this,f,G).call(this,e[0]),m(this,f,z).call(this,e[1])]}getID(){return"epsg:3857"}}f=new WeakSet,F=function(e){return e/180*this.HALF_EARTH},N=function(e){var t=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return t*this.HALF_EARTH/180},G=function(e){return e/this.HALF_EARTH*180},z=function(e){var t=e/this.HALF_EARTH*180;return t=180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2),t};class X{constructor(e,t,n={},a=null){u(this,g);u(this,P);u(this,E);u(this,y);u(this,D);u(this,A);u(this,O);u(this,p);u(this,T);u(this,b);u(this,v);this.scene=e,this.camera=t,c(this,P,new C),c(this,E,{}),c(this,y,null),c(this,D,0),c(this,A,100),c(this,O,null),this.setGpsOptions(n),c(this,p,null),c(this,T,0),c(this,b,0),c(this,v,a)}setProjection(e){c(this,P,e)}setGpsOptions(e={}){e.gpsMinDistance!==void 0&&c(this,D,e.gpsMinDistance),e.gpsMinAccuracy!==void 0&&c(this,A,e.gpsMinAccuracy)}async startGps(){if(i(this,v)){const t=await(await i(this,v).sendData("/gps/start",{gpsMinDistance:i(this,D),gpsMinAccuracy:i(this,A)})).json();c(this,b,t.session)}return i(this,O)===null?(c(this,O,navigator.geolocation.watchPosition(e=>{m(this,g,x).call(this,e)},e=>{i(this,E).gpserror?i(this,E).gpserror(e.code):alert(`GPS error: code ${e.code}`)},{enableHighAccuracy:!0})),!0):!1}stopGps(){return i(this,O)!==null?(navigator.geolocation.clearWatch(i(this,O)),c(this,O,null),!0):!1}fakeGps(e,t,n=null,a=0){n!==null&&this.setElevation(n),m(this,g,x).call(this,{coords:{longitude:e,latitude:t,accuracy:a}})}lonLatToWorldCoords(e,t){const n=i(this,P).project(e,t);if(i(this,p))n[0]-=i(this,p)[0],n[1]-=i(this,p)[1];else throw"No initial position determined";return[n[0],-n[1]]}add(e,t,n,a,l={}){var w;e.properties=l,m(this,g,S).call(this,e,t,n,a),this.scene.add(e),(w=i(this,v))==null||w.sendData("/object/new",{position:e.position,x:e.position.x,z:e.position.z,session:i(this,b),properties:l})}setElevation(e){this.camera.position.y=e}on(e,t){i(this,E)[e]=t}}P=new WeakMap,E=new WeakMap,y=new WeakMap,D=new WeakMap,A=new WeakMap,O=new WeakMap,p=new WeakMap,T=new WeakMap,b=new WeakMap,v=new WeakMap,g=new WeakSet,S=function(e,t,n,a){const l=this.lonLatToWorldCoords(t,n);a!==void 0&&(e.position.y=a),[e.position.x,e.position.z]=l},k=function(e,t){c(this,p,i(this,P).project(e,t))},x=function(e){var n,a,l;let t=Number.MAX_VALUE;I(this,T)._++,(n=i(this,v))==null||n.sendData("/gps/new",{gpsCount:i(this,T),lat:e.coords.latitude,lon:e.coords.longitude,acc:e.coords.accuracy,session:i(this,b)}),e.coords.accuracy<=i(this,A)&&(i(this,y)===null?c(this,y,{latitude:e.coords.latitude,longitude:e.coords.longitude}):t=m(this,g,Q).call(this,i(this,y),e.coords),t>=i(this,D)&&(i(this,y).longitude=e.coords.longitude,i(this,y).latitude=e.coords.latitude,i(this,p)||(m(this,g,k).call(this,e.coords.longitude,e.coords.latitude),(a=i(this,v))==null||a.sendData("/worldorigin/new",{gpsCount:i(this,T),lat:e.coords.latitude,lon:e.coords.longitude,session:i(this,b),initialPosition:i(this,p)})),m(this,g,S).call(this,this.camera,e.coords.longitude,e.coords.latitude),(l=i(this,v))==null||l.sendData("/gps/accepted",{gpsCount:i(this,T),cameraX:this.camera.position.x,cameraZ:this.camera.position.z,session:i(this,b),distMoved:t}),i(this,E).gpsupdate&&i(this,E).gpsupdate(e,t)))},Q=function(e,t){const n=o.MathUtils.degToRad(t.longitude-e.longitude),a=o.MathUtils.degToRad(t.latitude-e.latitude),l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(o.MathUtils.degToRad(e.latitude))*Math.cos(o.MathUtils.degToRad(t.latitude))*(Math.sin(n/2)*Math.sin(n/2));return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3};class V{constructor(e,t,n){this.renderer=e,this.renderer.autoClear=!1,this.sceneWebcam=new o.Scene;let a;t?a=document.querySelector(t):(a=document.createElement("video"),a.setAttribute("autoplay",!0),a.setAttribute("playsinline",!0),a.style.display="none",document.body.appendChild(a)),this.geom=new o.PlaneGeometry,this.texture=new o.VideoTexture(a),this.material=new o.MeshBasicMaterial({map:this.texture});const l=new o.Mesh(this.geom,this.material);if(this.sceneWebcam.add(l),this.cameraWebcam=new o.OrthographicCamera(-.5,.5,.5,-.5,0,10),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const w={video:{width:(n==null?void 0:n.width)||1280,height:(n==null?void 0:n.height)||720,facingMode:"environment"}};navigator.mediaDevices.getUserMedia(w).then(R=>{console.log("using the webcam successfully..."),a.srcObject=R,a.play()}).catch(R=>{setTimeout(()=>{alert(`Webcam Error
Name: `+R.name+`
Message: `+R.message)},1e3)})}else setTimeout(()=>{alert("sorry - media devices API not supported")},1e3)}update(){this.renderer.clear(),this.renderer.render(this.sceneWebcam,this.cameraWebcam),this.renderer.clearDepth()}dispose(){this.material.dispose(),this.texture.dispose(),this.geom.dispose()}}const B=new o.Vector3(0,0,1),U=new o.Euler,Y=new o.Quaternion,Z=new o.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),$={type:"change"};class J extends o.EventDispatcher{constructor(e){super(),window.isSecureContext===!1&&console.error("THREE.DeviceOrientationControls: DeviceOrientationEvent is only available in secure contexts (https)");const t=this,n=1e-6,a=new o.Quaternion;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0,this.deviceOrientationEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation";const l=function(d){t.deviceOrientation=d},w=function(){t.screenOrientation=window.orientation||0},R=function(d,H,L,j,W){U.set(L,H,-j,"YXZ"),d.setFromEuler(U),d.multiply(Z),d.multiply(Y.setFromAxisAngle(B,-W))};this.connect=function(){w(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(function(d){d=="granted"&&(window.addEventListener("orientationchange",w),window.addEventListener(t.deviceOrientationEventName,l))}).catch(function(d){console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",d)}):(window.addEventListener("orientationchange",w),window.addEventListener(t.deviceOrientationEventName,l)),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",w),window.removeEventListener(t.deviceOrientationEventName,l),t.enabled=!1},this.update=function(){if(t.enabled===!1)return;const d=t.deviceOrientation;if(d){const H=d.alpha?o.MathUtils.degToRad(d.alpha)+t.alphaOffset:0,L=d.beta?o.MathUtils.degToRad(d.beta):0,j=d.gamma?o.MathUtils.degToRad(d.gamma):0,W=t.screenOrientation?o.MathUtils.degToRad(t.screenOrientation):0;R(t.object.quaternion,H,L,j,W),8*(1-a.dot(t.object.quaternion))>n&&(a.copy(t.object.quaternion),t.dispatchEvent($))}},this.dispose=function(){t.disconnect()},this.connect()}}class K{constructor(e){this.raycaster=new o.Raycaster,this.normalisedMousePosition=new o.Vector2(null,null),e.domElement.addEventListener("click",t=>{this.normalisedMousePosition.set(t.clientX/e.domElement.clientWidth*2-1,-(t.clientY/e.domElement.clientHeight*2)+1)})}raycast(e,t){if(this.normalisedMousePosition.x!==null&&this.normalisedMousePosition.y!==null){this.raycaster.setFromCamera(this.normalisedMousePosition,e);const n=this.raycaster.intersectObjects(t.children,!1);return this.normalisedMousePosition.set(null,null),n}return[]}}s.ClickHandler=K,s.DeviceOrientationControls=J,s.LocationBased=X,s.SphMercProjection=C,s.WebcamRenderer=V,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
