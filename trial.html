<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Trial — labelled waypoints</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/3.4.0/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin:0">
    <a-scene embedded arjs="sourceType: webcam;" vr-mode-ui="enabled: false">
      <!-- Custom component (fixed template-strings, added guards) -->
      <script>
        AFRAME.registerComponent('waypoints-manager', {
          init () {
            this.fetchAndPlace();
            this.showOrientation();
          },

          fetchAndPlace: async function () {
            const routeId = new URLSearchParams(location.search).get('routeId');
            if (!routeId) { console.error('No routeId parameter in URL'); return; }

            const waypointsUrl = `https://waypoints-prht.onrender.com/get-waypoints/${routeId}`;

            try {
              const res  = await fetch(waypointsUrl);
              const json = await res.json();

              (json.waypoints || []).forEach((waypoint, index) => {
                if (!waypoint.lat || !waypoint.lng) {
                  console.error(`Invalid coordinates for waypoint ${index + 1}`);
                  return;
                }

                const text   = document.createElement('a-text');
                text.setAttribute('value', `Point ${index + 1}`);
                text.setAttribute('scale', '75 75 75');
                text.setAttribute('align', 'center');
                text.setAttribute('color', this.pickColor(index));
                text.setAttribute('look-at', '[gps-camera]');
                text.setAttribute('gps-entity-place',
                                  `latitude: ${waypoint.lat}; longitude: ${waypoint.lng}`);

                this.el.sceneEl.appendChild(text);
                console.log(`Added waypoint ${index + 1} → lat ${waypoint.lat}, lon ${waypoint.lng}`);
              });
            } catch (err) {
              console.error('Error fetching waypoints:', err);
            }
          },

          pickColor: function (i) {
            return ['red', 'blue', 'green', 'yellow', 'purple', 'orange'][i % 6];
          },

          showOrientation: function () {
            const overlay = document.createElement('div');
            overlay.style.cssText =
              'position:fixed;top:0;left:0;right:0;padding:.3rem .6rem;' +
              'font:12px monospace;background:rgba(0,0,0,.6);color:#0f0;z-index:10;';
            document.body.appendChild(overlay);

            const update = () => {
              const so = screen.orientation || {};
              overlay.textContent =
                `alpha: ${so.alpha ?? 'N/A'} | beta: ${so.beta ?? 'N/A'} | gamma: ${so.gamma ?? 'N/A'}`;
            };
            window.addEventListener('deviceorientation', update);
            update();
          }
        });
      </script>

      <a-entity waypoints-manager></a-entity>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>
