<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Navigation with Three.js & Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
    }
    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 99999;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      border-radius: 12px;
      padding: 12px 16px;
      line-height: 1.4;
    }
    #ui label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    #ui input {
      width: 160px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
      margin-bottom: 8px;
    }
    #ui button {
      width: 100%;
      padding: 6px 0;
      border: none;
      border-radius: 6px;
      background: #0b84ff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Simple UI overlay -->
  <div id="ui">
    <label>Destination Lat:
      <input type="number" id="destLat" step="0.000001" placeholder="e.g. 52.520008" />
    </label>
    <label>Destination Lon:
      <input type="number" id="destLon" step="0.000001" placeholder="e.g. 13.404954" />
    </label>
    <button id="goBtn">Draw Route</button>
  </div>

  <!-- Google Maps JS API (⚠️ replace YOUR_API_KEY) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuQ4ijj8UEZrge9r0j9Feo5DTb1fb5WXQ&libraries=geometry"></script>

  <!-- Three.js & WebXR (module imports) -->
  <script type="module" defer>
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/webxr/ARButton.js';

    // ---------------------------------------------------------------------------
    // ↳ HTML elements
    // ---------------------------------------------------------------------------
    const destLatInput = document.getElementById('destLat');
    const destLonInput = document.getElementById('destLon');
    const goBtn        = document.getElementById('goBtn');

    // ---------------------------------------------------------------------------
    // ↳ Scene globals
    // ---------------------------------------------------------------------------
    let scene, camera, renderer;
    let startLat, startLon;             // First GPS fix (origin of local coords)
    let destLat, destLon;               // Destination entered by user
    let metersPerDegLat;                // ~111 km per ° lat
    let metersPerDegLon;                // depends on latitude
    const chevronGroup = new THREE.Group();

    // ---------------------------------------------------------------------------
    // ↳ Utility helpers
    // ---------------------------------------------------------------------------

    // Convert lat/lon to a local right‑handed ENU coordinate (in metres)
    const latLonToVector = (lat, lon) => {
      const x = (lon - startLon) * metersPerDegLon;          // +x ‑ east
      const z = (lat - startLat) * metersPerDegLat;          // +z ‑ north (we’ll invert later)
      return new THREE.Vector3(x, 0, -z);                    // -z because Three.js forward is -z
    };

    // Build chevron cones along the great‑circle heading from origin → dest
    const buildChevrons = () => {
      // Wipe any previous route
      chevronGroup.children.length = 0;

      // Safety: ensure Google Maps has loaded
      if (!window.google || !google.maps || !google.maps.geometry) {
        alert('Google Maps API still loading. Try again in a second …');
        return;
      }

      const origin = new google.maps.LatLng(startLat, startLon);
      const target = new google.maps.LatLng(destLat,  destLon);

      const distance = google.maps.geometry.spherical.computeDistanceBetween(origin, target); // m
      const heading  = google.maps.geometry.spherical.computeHeading(origin, target);          // °

      const interval = 2;                   // metres between chevrons
      for (let d = interval; d <= distance; d += interval) {
        const waypoint = google.maps.geometry.spherical.computeOffset(origin, d, heading);
        const wpVec    = latLonToVector(waypoint.lat(), waypoint.lng());

        // Chevron geometry (cone)
        const coneGeo = new THREE.ConeGeometry(0.30, 0.70, 6);
        const coneMat = new THREE.MeshBasicMaterial({ color: 0x00e0ff });
        const cone    = new THREE.Mesh(coneGeo, coneMat);
        cone.position.copy(wpVec);

        // Point the cone towards the next waypoint / destination
        cone.lookAt(new THREE.Vector3().copy(wpVec).add(new THREE.Vector3().subVectors(wpVec, latLonToVector(startLat, startLon)).normalize()));

        chevronGroup.add(cone);
      }
      scene.add(chevronGroup);
    };

    // ---------------------------------------------------------------------------
    // ↳ Three.js + WebXR setup
    // ---------------------------------------------------------------------------
    const initThree = () => {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera();
      scene.add(camera);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // WebXR AR button (with DOM overlay so UI stays visible)
      document.body.appendChild(
        ARButton.createButton(renderer, {
          requiredFeatures: ['local-floor', 'hit-test', 'dom-overlay'],
          domOverlay: { root: document.body }
        })
      );

      renderer.setAnimationLoop(render);
    };

    // ---------------------------------------------------------------------------
    // ↳ Render loop
    // ---------------------------------------------------------------------------
    const render = (t, frame) => {
      // (Optional) Per‑frame logic can be added here
      renderer.render(scene, camera);
    };

    // ---------------------------------------------------------------------------
    // ↳ Geolocation
    // ---------------------------------------------------------------------------
    const watchUserPosition = () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported on this device/browser');
        return;
      }

      navigator.geolocation.watchPosition(
        pos => {
          if (startLat === undefined) {
            // First fix ⇒ set it as origin
            startLat = pos.coords.latitude;
            startLon = pos.coords.longitude;
            metersPerDegLat = 110540;                               // ≈ constant
            metersPerDegLon = 111320 * Math.cos(startLat * Math.PI / 180);
          }
          // In a full‑app you’d translate the camera based on GPS drift here
        },
        err => console.error(err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    };

    // ---------------------------------------------------------------------------
    // ↳ UI events
    // ---------------------------------------------------------------------------
    goBtn.addEventListener('click', () => {
      if (startLat === undefined) {
        alert('Waiting for initial GPS fix …');
        return;
      }

      destLat = parseFloat(destLatInput.value);
      destLon = parseFloat(destLonInput.value);

      if (isNaN(destLat) || isNaN(destLon)) {
        alert('Please enter valid decimal coordinates for the destination.');
        return;
      }

      buildChevrons();
    });

    // ---------------------------------------------------------------------------
    // ↳ Kick everything off!
    // ---------------------------------------------------------------------------
    window.addEventListener('load', () => {
      initThree();
      watchUserPosition();
    });
  </script> 
</body>
</html>
